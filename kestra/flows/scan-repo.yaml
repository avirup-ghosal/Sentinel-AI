id: scan-repo
namespace: devsecops
description: Clone a GitHub repository and run Trivy + Gitleaks scans with persisted results

inputs:
  - id: repoUrl
    type: STRING
    description: Public GitHub repository URL
    required: true

tasks:
  - id: security_scan_flow
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:

      - id: clone_repo
        type: io.kestra.plugin.git.Clone
        url: "{{ inputs.repoUrl }}"

      # -------------------------------
      # Trivy Scan (JSON output)
      # -------------------------------
      - id: trivy_scan
        type: io.kestra.plugin.scripts.shell.Commands
        description: Trivy filesystem scan (JSON)
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
          image: aquasec/trivy:latest
          entryPoint: []
        commands:
          - trivy fs . -f json -o trivy.json
        outputFiles:
          - trivy.json

      # -------------------------------
      # Gitleaks Scan (JSON output)
      # -------------------------------
      - id: gitleaks_scan
        type: io.kestra.plugin.scripts.shell.Commands
        description: Gitleaks secrets scan (JSON)
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
          image: zricethezav/gitleaks:latest
          entryPoint: []
        commands:
          - gitleaks detect --source=. --no-git --report-format json --report-path gitleaks.json
        outputFiles:
          - gitleaks.json